protocolVersion: 2
name: nerfstudio
type: job
prerequisites:
  - type: dockerimage
    uri: >-
      master.garching.cluster.campar.in.tum.de:10443/nerf-studio/nerf-studio:latest
    name: docker_image_0
    auth:
      username: eckertleo
      password: <% $secrets.docker_password_0 %>
      registryuri: ''
secrets:
  docker_password_0: <harbor_cli_secret>
taskRoles:
  taskrole:
    instances: 1
    completion:
      minFailedInstances: 1
    taskRetryCount: 0
    dockerImage: docker_image_0
    resourcePerInstance:
      gpu: 1
      cpu: 4
      memoryMB: 30000
      ports:
        viewer: 1
    nodeSelectionPerInstance:
      - key: nvidia.com/gpu.memory
        operator: Gt
        values:
          - '0'
      - key: nvidia.com/gpu.compute.major
        operator: Gt
        values:
          - '0'
    commands:
      - pwd 
      - cat ~/.bashrc
      - export PATH="/usr/local/cuda-11.8/bin:$PATH" >> ~/.bashrc
      - export LD_LIBRARY_PATH="/usr/local/cuda-11.8/lib64:$LD_LIBRARY_PATH" >> ~/.bashrc
      - source .bashrc
      - cat ~/.bashrc
      - cd ../../mnt/scratch/${PAI_JOB_NAME}
      - pwd
      - sleep infinity

extras:
  com.microsoft.pai.runtimeplugin:
    - plugin: ssh
      parameters:
        jobssh: true
        userssh:
          type: custom
          value: ''
    - plugin: teamwise_storage
      parameters:
        storageConfigNames:
          - ceph-scratch
          - nfs-datasets
          - nfs-projects
          - nfs-workfiles
  jobStatusChangeNotification:
    running: false
    succeeded: false
    stopped: false
    failed: true
    retried: false
